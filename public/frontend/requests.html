<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Solicitudes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/exact-style.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="requestsPage()" x-init="load()">
  <div class="header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="assets/logo1.png" class="logo">
      <img src="assets/logo2.png" class="logo">
    </div>
    <div class="d-flex align-items-center">
      <div class="me-3">Hola <strong x-text="userName"></strong></div>
      <div style="margin-left:auto"><button class="btn btn-outline-dark" @click="logout()">Salir</button></div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-2">
        <div class="sidebar">
          <a href="dashboard.html">Inicio</a>
          <a href="users.html" x-show="role==='coordinador'">Usuarios</a>
          <a href="products.html">Productos</a>
          <a href="requests.html">Solicitudes</a>
          <a href="reports.html">Reportes</a>
        </div>
      </div>

      <div class="col-9">
        <div class="card-panel">
          <h3 class="text-center mb-5">Solicitudes</h3>
          <div class="d-flex justify-content-center align-items-center gap-5">
            <button class="btn btn-primary btn-lg d-flex flex-column align-items-center" style="min-width: 300px; padding: 50px 70px;" @click="window.location.href='requests_pres.html'">
              <i class="bi bi-arrow-repeat" style="font-size: 5rem;"></i>
              <span class="mt-3" style="font-size: 1.8rem;">Pr√©stamo</span>
            </button>
            <button class="btn btn-secondary btn-lg d-flex flex-column align-items-center" style="min-width: 300px; padding: 50px 70px;" @click="window.location.href='requests_sal.html'">
              <i class="bi bi-box-arrow-right" style="font-size: 5rem;"></i>
              <span class="mt-3" style="font-size: 1.8rem;">Salida</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
  function requestsPage(){
    return {
      role: (localStorage.getItem('role') || 'encargado'),
      userName: (localStorage.getItem('userName') || ''),
      requests: [], products: [], modal:false, form:{items:[]}, newItem:{product_id:'',quantity:1},
      async load(){
        const r = await apiFetch('/requests','GET'); if(r.ok) this.requests = r.data;
        const p = await apiFetch('/products','GET'); if(p.ok) this.products = p.data;
        try{ const s = await apiFetch('/dashboard/summary','GET'); if(s.ok){ this.role = s.data.role || this.role; this.userName = s.data.user?.name || this.userName; if(this.userName) localStorage.setItem('userName', this.userName); if(this.role) localStorage.setItem('role', this.role); } }catch(e){}
      },
      logout(){ localStorage.removeItem('token'); localStorage.removeItem('userName'); localStorage.removeItem('role'); window.location='index.html'; },
      new(type){ this.form = {type:type, items:[], solicitante:'', return_date:null}; this.modal=true; },
      addItem(){ const p = this.products.find(x=>x.id==this.newItem.product_id); if(!p) return; this.form.items.push({product_id:p.id,name:p.name,quantity:this.newItem.quantity}); this.newItem={product_id:'',quantity:1}; },
      async save(){ 
        if(!this.form.solicitante || this.form.solicitante.trim() === ''){
          alert('Debe ingresar el nombre del solicitante');
          return;
        }
        if(!this.form.items || this.form.items.length === 0){
          alert('Debe agregar al menos un producto');
          return;
        }
        const body={type:this.form.type, solicitante:this.form.solicitante, items:this.form.items, return_date:this.form.return_date}; 
        console.log('Enviando solicitud:', body);
        const r = await apiFetch('/requests','POST',body); 
        if(r.ok){
          alert('Solicitud creada exitosamente');
          this.modal=false; 
          this.load();
        } else {
          const errorMsg = r.data?.error || r.data?.message || JSON.stringify(r.data?.errors || r.data) || 'Error desconocido';
          alert('Error al crear solicitud: ' + errorMsg);
          console.error('Error response:', r);
        }
      },
      view(r){ alert(JSON.stringify(r)); },
      async del(r){ if(!confirm('Eliminar?')) return; await apiFetch('/requests/'+r.id,'DELETE'); this.load(); }
    };
  }
  </script>
</body>
</html>