<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/exact-style.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    .password-wrapper {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      color: #6c757d;
      font-size: 18px;
    }
    .password-toggle:hover {
      color: #495057;
    }
  </style>
</head>
<body x-data="usersPage()" x-init="load()">
  <div class="header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="assets/logo1.png" class="logo">
      <img src="assets/logo2.png" class="logo">
    </div>
    <div class="d-flex align-items-center">
      <div class="me-3">Hola <strong x-text="userName"></strong></div>
      <div><button class="btn btn-outline-dark" @click="logout()">Salir</button></div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-2">
        <div class="sidebar">
          <a href="dashboard.html">Inicio</a>
          <a href="users.html" x-show="role==='coordinador'">Usuarios</a>
          <a href="products.html">Productos</a>
          <a href="requests.html">Solicitudes</a>
          <a href="reports.html">Reportes</a>
        </div>
      </div>
      <div class="col-9">
        <div class="card-panel">
          <div class="d-flex justify-content-between">
            <h3>Usuarios</h3>
            <button class="btn btn-primary" @click="openNew()">Agregar usuario</button>
          </div>

          <table class="table table-soft mt-3">
            <thead>
              <tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Activo</th><th>Acción</th></tr>
            </thead>
            <tbody>
              <template x-for="u in users" :key="u.id">
                <tr>
                  <td x-text="u.id"></td>
                  <td x-text="u.name"></td>
                  <td x-text="u.email"></td>
                  <td x-text="u.role"></td>
                  <td x-text="u.active? 'Sí':'No'"></td>
                  <td>
                    <button class="btn btn-sm btn-secondary" @click="edit(u)">Editar</button>
                    <button class="btn btn-sm btn-danger" @click="toggle(u)"><span x-text="u.active? 'Dar baja':'Activar'"></span></button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal sencillo para crear/editar usuario -->
  <div x-show="modal" x-cloak style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:1050;padding:16px">
    <div class="card p-3" style="width:520px;max-width:600px;margin:auto;max-height:90vh;overflow-y:auto" @click.outside="modal=false">
      <h5 x-text="form.id ? 'Editar usuario' : 'Nuevo usuario'"></h5>

      <div class="mb-2">
        <label class="form-label">Nombre</label>
        <input class="form-control" type="text" x-model="form.name" placeholder="Nombre completo">
      </div>

      <div class="mb-2">
        <label class="form-label">Email</label>
        <input class="form-control" type="email" x-model="form.email" placeholder="correo@ejemplo.com">
      </div>

      <div class="mb-2">
        <label class="form-label">Rol</label>
        <select class="form-select" x-model="form.role">
          <option value="encargado">Encargado</option>
          <option value="coordinador">Coordinador</option>
        </select>
      </div>

        <div class="mb-3">
          <label class="form-label">Contraseña</label>
        <div class="password-wrapper">
          <input class="form-control" :type="showPassword ? 'text' : 'password'" x-model="form.password" :required="!form.id" :placeholder="form.id ? 'Dejar vacío para no cambiar' : ''" minlength="4" style="padding-right: 40px;">
          <button type="button" class="password-toggle" @click="showPassword = !showPassword">
            <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
          </button>
        </div>
        <div class="form-text" x-show="!form.id">La contraseña es obligatoria al agregar usuario.</div>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="activeCheck" x-model="form.active">
        <label class="form-check-label" for="activeCheck">Activo</label>
      </div>

      <div class="text-end">
        <button class="btn btn-secondary me-2" @click="modal=false">Cancelar</button>
        <button class="btn btn-primary" @click="save()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
  function usersPage(){
    return {
      role: (localStorage.getItem('role') || 'encargado'),
      userName: (localStorage.getItem('userName') || ''),
      users: [], modal:false, form: {}, showPassword: false,
      async load(){
        const r = await apiFetch('/users','GET'); if(r.ok) this.users = r.data;
        try{
          const s = await apiFetch('/dashboard/summary','GET');
          if(s.ok){
            this.role = s.data.role || this.role;
            this.userName = s.data.user?.name || this.userName;
            if(this.userName) localStorage.setItem('userName', this.userName);
            if(this.role) localStorage.setItem('role', this.role);
          }
        }catch(e){}
      },
      logout(){ localStorage.removeItem('token'); localStorage.removeItem('userName'); localStorage.removeItem('role'); window.location='index.html'; },
      openNew(){ this.form = { role: 'encargado', active: true, password: '' }; this.showPassword = false; this.modal = true; },
      edit(u){ this.form = Object.assign({}, u); this.form.active = !!this.form.active; this.form.password = ''; this.showPassword = false; this.modal = true; },
      async save(){
        // Validación: contraseña obligatoria al agregar (sin id)
        if(!this.form.id){
          const pwd = (this.form.password || '').trim();
          if(!pwd){
            alert('Llenar contraseña al agregar usuario.');
            return;
          }
        }
        
        // Preparar datos para enviar
        const payload = {
          name: this.form.name,
          email: this.form.email,
          role: this.form.role
        };
        
        // Solo incluir password si tiene valor (y no es solo espacios)
        const pwd = (this.form.password || '').trim();
        if(pwd){
          payload.password = pwd;
          console.log('Enviando contraseña, longitud:', pwd.length);
        } else {
          console.log('No se envía contraseña (vacía o no modificada)');
        }
        
        // Solo incluir active al crear (el backend usa toggle para cambiar estado)
        if(!this.form.id){
          payload.active = this.form.active;
        }
        
        console.log('Payload final:', payload);
        
        let r;
        if(this.form.id){
          r = await apiFetch('/users/'+this.form.id,'PUT',payload);
        } else {
          r = await apiFetch('/users','POST',payload);
        }
        if(!r.ok){
          const msg = (r.data && (r.data.message || JSON.stringify(r.data.errors||r.data))) || 'Error al guardar';
          alert(msg);
          console.error('Error response:', r);
          return;
        }
        this.modal=false; this.load();
      },
      async toggle(u){ await apiFetch('/users/'+u.id+'/toggle','POST'); this.load(); }
    };
  }
  </script>
</body>
</html>