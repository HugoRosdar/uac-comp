<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>UAC - Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="css/exact-style.css" rel="stylesheet">
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="dashboard()" x-init="init()">
  <div class="header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="assets/logo1.png" class="logo">
      <img src="assets/logo2.png" class="logo">
    </div>
    <div class="d-flex align-items-center">
      <div class="me-3">Hola <strong x-text="userName"></strong></div>
      <div class="logout"><button class="btn btn-outline-dark" @click="logout()">Salir</button></div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-2">
        <div class="sidebar">
          <a href="dashboard.html" class="active">Inicio</a>
          <!-- Mostrar Usuarios solo si el rol es coordinator -->
          <a href="users.html" x-show="role === 'coordinador'">Usuarios</a>
          <a href="products.html">Productos</a>
          <a href="requests.html">Solicitudes</a>
          <a href="reports.html">Reportes</a>
        </div>
      </div>
      <div class="col-9">
        <!-- Solicitudes Pendientes -->
        <div class="card-panel mb-4" style="border-left: 4px solid #0d6efd;">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <h4 class="text-primary">Solicitudes de Préstamo - Pendientes</h4>
            <div class="small-muted">5 últimos</div>
          </div>
          <table class="table table-soft">
            <thead class="table-primary"><tr><th>#</th><th>Folio</th><th>Solicitante</th><th>Fecha devolución</th><th>Acción</th></tr></thead>
            <tbody>
              <template x-for="(d,i) in pending" :key="d.id">
                <tr :class="{'table-danger': d.overdue}">
                  <td x-text="i+1"></td>
                  <td x-text="d.folio"></td>
                  <td x-text="d.solicitante"></td>
                  <td x-text="d.return_date"></td>
                  <td>
                    <button class="btn btn-success btn-sm" @click="markReturned(d.id)">Devuelto</button>
                    <a href="#" class="text-primary ms-2" @click.prevent="viewDetails(d.id)">Ver más...</a>
                  </td>
                </tr>
              </template>
              <tr x-show="pending.length==0"><td colspan="5">No hay solicitudes pendientes</td></tr>
            </tbody>
          </table>
        </div>

        <div class="row">
          <!-- Productos bajo stock -->
          <div class="col-5">
            <div class="card-panel" style="border-left: 4px solid #ffa007;">
              <h5 class="text-warning">Productos bajo stock</h5>
              <table class="table table-soft">
                <thead class="table-warning"><tr><th>Producto</th><th>Stock</th></tr></thead>
                <tbody><template x-for="p in low"><tr><td x-text="p.name"></td><td><span class="badge-low" x-text="p.quantity"></span></td></tr></template></tbody>
              </table>
            </div>
          </div>
          
          <!-- Productos agotados -->
          <div class="col-5">
            <div class="card-panel" style="border-left: 4px solid #dc3545;">
              <h5 class="text-danger">Productos agotados</h5>
              <table class="table table-soft">
                <thead class="table-danger"><tr><th>Producto</th></tr></thead>
                <tbody><template x-for="p in out"><tr><td class="text-danger" x-text="p.name"></td></tr></template></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal de Detalles de Solicitud -->
  <template x-if="showModal">
    <div class="modal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalles de la Solicitud</h5>
            <button type="button" class="btn-close" @click="closeModal()"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Folio:</strong>
                <p x-text="requestDetails?.folio"></p>
              </div>
              <div class="col-md-6">
                <strong>Tipo:</strong>
                <p x-text="translateType(requestDetails?.type)"></p>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Solicitante:</strong>
                <p x-text="requestDetails?.solicitante"></p>
              </div>
              <div class="col-md-6">
                <strong>Estado:</strong>
                <p x-text="translateStatus(requestDetails?.status)"></p>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Fecha de Solicitud:</strong>
                <p x-text="requestDetails?.created_at"></p>
              </div>
              <div class="col-md-6" x-show="requestDetails?.return_date">
                <strong>Fecha de Devolución:</strong>
                <p x-text="requestDetails?.return_date"></p>
              </div>
            </div>
            <div class="mb-3" x-show="requestDetails?.items && requestDetails.items.length > 0">
              <strong>Productos:</strong>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="item in requestDetails.items" :key="item.id">
                    <tr>
                      <td x-text="item.product_name || item.name"></td>
                      <td x-text="item.quantity"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="closeModal()">Cerrar</button>
            <button type="button" class="btn btn-success" @click="markReturnedFromModal()">Marcar como Devuelto</button>
          </div>
        </div>
      </div>
    </div>
  </template>

<script src="js/app.js"></script>
<script>
function dashboard(){ return {
  role: (localStorage.getItem('role') || 'encargado'), userName: (localStorage.getItem('userName') || ''), pending:[], low:[], out:[],
  showModal: false, requestDetails: null,
  async init(){
    console.log('Dashboard init - Token:', localStorage.getItem('token'));
    console.log('Dashboard init - userName:', this.userName);
    console.log('Dashboard init - role:', this.role);
    
    const r = await apiFetch('/dashboard/summary','GET');
    console.log('Dashboard summary response:', r);
    console.log('Response status:', r.status);
    console.log('Response ok:', r.ok);
    console.log('Response data:', JSON.stringify(r.data, null, 2));
    
    if(r.ok){
      console.log('Dashboard data:', r.data);
      // Procesar solicitudes pendientes y marcar las vencidas
      this.pending = (r.data.pending || []).map(p => {
        // Verificar si la fecha de devolución ya pasó
        if (p.return_date) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const returnDate = new Date(p.return_date);
          returnDate.setHours(0, 0, 0, 0);
          p.overdue = returnDate < today;
        } else {
          p.overdue = false;
        }
        return p;
      });
      this.low = r.data.low || [];
      this.out = r.data.out || [];
      this.role = r.data.role || 'encargado';
      this.userName = (r.data.user && r.data.user.name) ? r.data.user.name : (this.userName || '');
      // actualizar localStorage con el nombre devuelto por el servidor (si hay)
      if(this.userName) localStorage.setItem('userName', this.userName);
      if(this.role) localStorage.setItem('role', this.role);
      console.log('Dashboard loaded - pending:', this.pending.length, 'low:', this.low.length, 'out:', this.out.length);
    } else {
      console.error('Dashboard failed:', r.status, r.data);
      const errorMsg = r.data.error || r.data.message || (r.status === 0 ? 'No se puede conectar al servidor' : 'Error desconocido (status: ' + r.status + ')');
      alert('Error cargando dashboard: ' + errorMsg);
    }
  },
  logout(){ localStorage.removeItem('token'); localStorage.removeItem('userName'); localStorage.removeItem('role'); window.location='index.html'; },
  async markReturned(id){ if(!confirm('Marcar como devuelto?')) return; await apiFetch('/requests/'+id+'/return','POST'); this.init(); },
  async viewDetails(id){
    const r = await apiFetch('/requests/' + id, 'GET');
    if(r.ok){
      this.requestDetails = r.data;
      this.showModal = true;
    } else {
      alert('Error al cargar detalles de la solicitud');
    }
  },
  closeModal(){
    this.showModal = false;
    this.requestDetails = null;
  },
  async markReturnedFromModal(){
    if(!this.requestDetails?.id) return;
    if(!confirm('¿Marcar como devuelto?')) return;
    await apiFetch('/requests/' + this.requestDetails.id + '/return', 'POST');
    this.closeModal();
    this.init();
  },
  translateType(type){
    const types = {
      'prestamo': 'Préstamo',
      'salida': 'Salida',
      'devolucion': 'Devolución'
    };
    return types[type] || type;
  },
  translateStatus(status){
    const statuses = {
      'pendiente': 'Pendiente',
      'activa': 'Aprobada',
      'aprobada': 'Aprobada',
      'devuelta': 'Devuelta',
      'cancelada': 'Cancelada'
    };
    return statuses[status] || status;
  }
};}
</script>
</body>
</html>

