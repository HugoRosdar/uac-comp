<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>UAC - Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="css/exact-style.css" rel="stylesheet">
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="dashboard()" x-init="init()">
  <div class="header">
    <img src="assets/logo1.png" class="logo">
    <img src="assets/logo2.png" class="logo">
    <div class="logout"><button class="btn btn-outline-dark" @click="logout()">Salir</button></div>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-2">
        <div class="sidebar">
          <a href="dashboard.html" class="active">Inicio</a>
          <template x-if="role==='coordinator'"><a href="users.html">Usuarios</a></template>
          <a href="products.html">Productos</a>
          <a href="requests.html">Solicitudes</a>
          <a href="reports.html">Reportes</a>
        </div>
      </div>
      <div class="col-9">
        <div class="card-panel">
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <h4>Solicitudes de Préstamo - Pendientes</h4>
            <div class="small-muted">Mostrando máximo 5 pendientes (ordenadas por fecha)</div>
          </div>
          <table class="table table-soft">
            <thead><tr><th>#</th><th>Producto</th><th>Solicitante</th><th>Fecha devolución</th><th>Acción</th></tr></thead>
            <tbody>
              <template x-for="(d,i) in pending" :key="d.id">
                <tr :class="{'table-danger': d.overdue}">
                  <td x-text="i+1"></td>
                  <td x-text="d.product"></td>
                  <td x-text="d.solicitante"></td>
                  <td x-text="d.return_date"></td>
                  <td><button class="btn btn-success btn-sm" @click="markReturned(d.id)">Devuelto</button></td>
                </tr>
              </template>
              <tr x-show="pending.length==0"><td colspan="5">No hay solicitudes pendientes</td></tr>
            </tbody>
          </table>

          <div class="row mt-4">
            <div class="col-6">
              <h5>Productos bajo stock</h5>
              <table class="table table-soft">
                <thead><tr><th>Producto</th><th>Stock</th></tr></thead>
                <tbody><template x-for="p in low"><tr><td x-text="p.name"></td><td><span class="badge-low" x-text="p.quantity"></span></td></tr></template></tbody>
              </table>
            </div>
            <div class="col-6">
              <h5>Productos agotados</h5>
              <table class="table table-soft">
                <thead><tr><th>Producto</th></tr></thead>
                <tbody><template x-for="p in out"><tr><td class="text-danger" x-text="p.name"></td></tr></template></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script src="js/app.js"></script>
<script>
function dashboard(){ return {
  role:'encargado', pending:[], low:[], out:[],
  async init(){
    const r = await apiFetch('/dashboard/summary','GET');
    if(r.ok){ this.pending = r.data.pending || []; this.low = r.data.low || []; this.out = r.data.out || []; this.role = r.data.role || 'encargado'; }
  },
  logout(){ localStorage.removeItem('token'); window.location='index.html'; },
  async markReturned(id){ if(!confirm('Marcar como devuelto?')) return; await apiFetch('/requests/'+id+'/return','POST'); this.init(); }
};}
</script>
</body>
</html>
